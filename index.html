<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grow a Garden Sign Up</title>
<style>
body {
  background-color: black;
  border: 2px solid lightslategray;
  padding: 15px 20px;
  font-family: 'Times New Roman', Times, serif;
  color: gray;
}
h1, h2, p {
  color: gray;
}
button {
  background-color: #2c2c2c;
  border: 2px solid #1a1a1a;
  color: #f5f5f5;
  padding: 15px 20px;
  cursor: pointer;
  border-radius: 8px;
  transition: background-color 0.3s, border-color 0.3s, color 0.3s;
}
button:hover {
  background-color: #3d3d3d;
  border-color: #444;
  color: #ffffff;
}
button:active {
  background-color: #1a1a1a;
  border-color: #555;
  color: #dddddd;
}
.custom-alert-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}
.custom-alert-box {
  background-color: #111;
  color: #fff;
  padding: 30px 40px;
  border-radius: 15px;
  text-align: center;
  box-shadow: 0 15px 50px rgba(0,0,0,0.8);
  width: 350px;
  border: 4px solid white;
}
.custom-alert-button {
  margin-top: 20px;
  background-color: #f04a4a;
  color: #fff;
  border: none;
  padding: 15px 30px;
  border-radius: 10px;
  cursor: pointer;
  transition: background-color 0.3s;
}
.custom-alert-button:hover {
  background-color: #d03737;
}
body.alert-active .custom-alert-overlay {
  opacity: 1;
  visibility: visible;
}
</style>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-type="module" data-presets="react,typescript" data-plugins="proposal-class-properties">

import * as React from "react";
import { useState, useEffect } from "react";

type CustomAlertProps = {
  message: string;
  onClose: () => void;
};

const CustomAlert: React.FC<CustomAlertProps> = ({ message, onClose }) => {
  useEffect(() => {
    document.body.classList.add('alert-active');
    return () => {
      document.body.classList.remove('alert-active');
    };
  }, []);
  return (
    <div className="custom-alert-overlay">
      <div className="custom-alert-box">
        <p>{message}</p>
        <button className="custom-alert-button" onClick={onClose}>OK</button>
      </div>
    </div>
  );
};

const SignupForm: React.FC = () => {
  const [email, setEmail] = useState<string>('');
  const [username, setUsername] = useState<string>('');
  const [password, setPassword] = useState<string>('');
  const [alert, setAlert] = useState<string | null>(null);
  const [token, setToken] = useState<string>('');
  const [loading, setLoading] = useState<boolean>(false);

  useEffect(() => {
    // Expose the callback globally for Turnstile
    (window as any).onTurnstileSuccess = (token: string) => {
      setToken(token);
    };
  }, []);

  const validateEmail = (email: string) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  const validateUsername = (username: string) => username.length >= 3;
  const validatePassword = (password: string) => password.length >= 6;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateEmail(email)) {
      setAlert('Please enter a valid email.');
      return;
    }
    if (!validateUsername(username)) {
      setAlert('Username must be at least 3 characters.');
      return;
    }
    if (!validatePassword(password)) {
      setAlert('Password must be at least 6 characters.');
      return;
    }
    if (!token) {
      setAlert('Please complete the CAPTCHA.');
      return;
    }
    setLoading(true);
    try {
      const res = await fetch('/function/database.js', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email, username, password, token }),
      });
      const data = await res.json();
      if (data.success) {
        setAlert('Signup successful!');
        setEmail('');
        setUsername('');
        setPassword('');
        (window as any).turnstile.reset();
        setToken('');
      } else {
        setAlert(data.message || 'Signup failed.');
      }
    } catch {
      setAlert('Network or server error.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      {alert && <CustomAlert message={alert} onClose={() => setAlert(null)} />}
      <h1>Grow a Garden Signup</h1>
      <form onSubmit={handleSubmit}>
        <p>
          <label>
            Email:<br />
            <input
              type="email"
              value={email}
              onChange={e => setEmail(e.target.value)}
              required
            />
          </label>
        </p>
        <p>
          <label>
            Username:<br />
            <input
              type="text"
              value={username}
              onChange={e => setUsername(e.target.value)}
              required
            />
          </label>
        </p>
        <p>
          <label>
            Password:<br />
            <input
              type="password"
              value={password}
              onChange={e => setPassword(e.target.value)}
              required
            />
          </label>
        </p>
        <div
          className="cf-turnstile"
          data-sitekey="0x4AAAAAABeDBe4pSr2MmYDv"
          data-callback="onTurnstileSuccess"
          data-theme="dark"
        />
        <p>
          <button type="submit" disabled={loading}>
            {loading ? 'Signing up...' : 'Sign Up'}
          </button>
        </p>
      </form>
    </>
  );
};

ReactDOM.createRoot(document.getElementById('root')!).render(<SignupForm />);

</script>
</body>
</html>
